(()=>{"use strict";
/*!
 *  電脳麻将: 牌理 v2.1.1
 *
 *  Copyright(C) 2017 Satoshi Kobayashi
 *  Released under the MIT license
 *  https://github.com/kobalab/Majiang/blob/master/LICENSE
 */
const{setSelector:a,clearSelector:i}=Majiang.UI.Util,t={},n={},o=Majiang.rule();let e;function p(a){if(t.shan=new Majiang.Shan(o),a)t.shoupai=Majiang.Shoupai.fromString(a),function(a,i){let t=i.toString();for(let i of t.match(/[mpsz][\d\+\=\-]+/g)){let t=i[0];for(let n of i.match(/\d/g)){let i=a._pai.indexOf(t+n);i>=0&&a._pai.splice(i,1)}}}(t.shan,t.shoupai);else{let a=[];for(;a.length<13;)a.push(t.shan.zimo());t.shoupai=new Majiang.Shoupai(a),t.shoupai.zimo(t.shan.zimo())}for(t.lizhi=!1;t.shan.paishu>17;)t.shan.zimo();$('form input[name="paistr"]').val(t.shoupai.toString()),a&&history.replaceState("","",`#${t.shoupai.toString()}`),n.shoupai=new Majiang.UI.Shoupai($(".shoupai"),n.pai,t.shoupai).redraw(!0),t.he=new Majiang.He,n.he=new Majiang.UI.He($(".he"),n.pai,t.he).redraw(!0),h(1)}function s(){for(let a of t.shoupai.get_dapai()){$("_"==a.substr(-1)?`.zimo .pai[data-pai="${a.substr(0,2)}"]`:`> .pai[data-pai="${a}"]`,$(".shoupai .bingpai")).attr("tabindex",0).attr("role","button").on("click.dapai",(i=>{$(i.target).addClass("dapai"),u(a)}))}a($(".shoupai .bingpai .pai[tabindex]"),"dapai",{focus:-1})}function u(a){i("dapai"),e.sound_on&&n.audio("dapai").play(),t.shoupai.dapai(a),n.shoupai.dapai(a),t.lizhi||0!=Majiang.Util.xiangting(t.shoupai)||(t.lizhi=!0,a+="*"),t.he.dapai(a),n.he.dapai(a),setTimeout(r,600)}function r(){if(!t.shan.paishu)return n.shoupai.redraw(),n.he.redraw(),$(".status").text("流局……"),void $(".paili").empty();t.shoupai.zimo(t.shan.zimo()),n.shoupai.redraw(),n.he.redraw(),h()}function h(a){$(".paili").empty();let i=Majiang.Util.xiangting(t.shoupai);if(-1==i?$(".status").text("和了！！"):0==i?$(".status").text("聴牌！"):$(".status").text(`${i}向聴`),-1==i)return void(e.sound_on&&n.audio("zimo").play());0!=i||t.lizhi||e.sound_on&&n.audio("lizhi").play();let o=[];for(let a of t.shoupai.get_dapai()){let n=t.shoupai.clone().dapai(a);if(Majiang.Util.xiangting(n)>i)continue;if(a=a[0]+(+a[1]||5),o.find((i=>i.p==a)))continue;let e=Majiang.Util.tingpai(n),p=e.map((a=>4-t.shoupai._bingpai[a[0]][a[1]])).reduce(((a,i)=>a+i),0);o.push({p:a,tingpai:e,n:p})}const p=(a,i)=>i.n-a.n||i.tingpai.length-a.tingpai.length||(a.p<i.p?-1:1);for(let a of o.sort(p)){let i="<div>打: "+$("<span>").append(n.pai(a.p)).html()+" 摸: "+a.tingpai.map((a=>$("<span>").append(n.pai(a)).html())).join("")+` (${a.n}枚)</div>`;$(".paili").append($(i))}a?setTimeout(s,600):s()}$((function(){n.pai=Majiang.UI.pai("#loaddata"),n.audio=Majiang.UI.audio("#loaddata"),e=JSON.parse(localStorage.getItem("Majiang.pref")),$('form input[type="button"]').on("click",(function(){return p(),!1})),$("form").on("submit",(function(){return p($('form input[name="paistr"]').val()),!1})),$("form").on("reset",(function(){$('input[name="paistr"]').trigger("focus"),history.replaceState("","",location.href.replace(/#.*$/,""))})),p(location.hash.replace(/^#/,""))}))})();